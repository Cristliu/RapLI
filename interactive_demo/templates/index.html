<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy-Preserving LLM Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --sidebar-width: 260px;
            --bg-color: #ffffff;
            --sidebar-bg: #f0f4f9;
            --chat-bubble-user: #d7f5fc; /* Light blue for user */
            --chat-bubble-bot: #f0f4f9; /* Light grey for bot */
            --primary-color: #0b57d0; /* Gemini Blue */
        }

        body { 
            background-color: var(--bg-color); 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 1rem;
            border-right: 1px solid #e0e0e0;
            transition: transform 0.3s ease;
        }
        
        .new-chat-btn {
            background-color: #dde3ea;
            color: #444746;
            border: none;
            border-radius: 15px;
            padding: 10px 15px;
            text-align: left;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            margin-bottom: 20px;
        }
        .new-chat-btn:hover {
            background-color: #d0d7de;
            color: #1f1f1f;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 10px;
        }
        .history-item {
            padding: 10px;
            border-radius: 20px;
            cursor: pointer;
            color: #444746;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
        }
        .history-item:hover, .history-item.active {
            background-color: #e0e4e9;
            color: #1f1f1f;
        }
        .history-item .title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        .history-item .actions {
            opacity: 0;
            display: flex;
            gap: 2px;
            transition: opacity 0.2s;
        }
        .history-item:hover .actions {
            opacity: 1;
        }
        .history-item .action-btn {
            border: none;
            background: transparent;
            color: #666;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .history-item .action-btn:hover {
            background-color: #d0d0d0;
            color: #1f1f1f;
        }
        .history-item .delete-btn:hover {
            color: #dc3545;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: white;
        }

        /* Top Bar */
        .top-bar {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* border-bottom: 1px solid #f0f0f0; */
        }
        .model-selector {
            border: none;
            background: transparent;
            font-weight: 600;
            color: #444746;
            cursor: pointer;
        }
        .model-selector:focus { outline: none; }

        /* Chat Area */
        .chat-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px 5%; 
            scroll-behavior: smooth;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #c4c7c5;
        }
        .welcome-text {
            font-size: 3rem;
            font-weight: 500;
            background: -webkit-linear-gradient(45deg, #4285f4, #9b72cb, #d96570);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        /* Messages */
        .message { margin-bottom: 24px; display: flex; gap: 15px; animation: fadeIn 0.3s ease-in; }
        .message.user { flex-direction: row-reverse; }
        .message.bot { flex-direction: row; }
        
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .user .avatar { background-color: #0b57d0; color: white; }
        .bot .avatar { background-color: #e0e0e0; color: #444746; } #icon-bot { color: #1f1f1f; }

        .bubble { 
            padding: 12px 18px; 
            border-radius: 18px; 
            max-width: 80%; 
            line-height: 1.6;
            position: relative; 
            font-size: 1rem;
        }
        .user .bubble { background-color: var(--chat-bubble-user); color: #1f1f1f; border-top-right-radius: 4px; }
        .bot .bubble { background-color: transparent; color: #1f1f1f; padding-left: 0; } /* Bot messages blend in more like Gemini */

        /* Input Area */
        .input-area { 
            padding: 20px 5%; 
            background: white; 
        }
        .input-container { 
            background-color: #f0f4f9;
            border-radius: 30px;
            padding: 8px 15px;
            display: flex; 
            align-items: flex-end;
            gap: 10px;
            transition: background-color 0.2s;
        }
        .input-container:focus-within {
            background-color: #e9eef6;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        
        textarea.form-control {
            background: transparent;
            border: none;
            resize: none;
            box-shadow: none;
            padding: 10px 0;
            max-height: 150px;
        }
        textarea.form-control:focus { background: transparent; box-shadow: none; }

        .send-btn {
            border: none;
            background: transparent;
            color: var(--primary-color);
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .send-btn:hover { background: #e0e4e9; }
        .send-btn:disabled { color: #ccc; }

        /* Token Highlighting */
        .token { cursor: pointer; padding: 2px 0; border-radius: 3px; margin: 0; display: inline-block; transition: all 0.2s; }
        .token:hover { opacity: 0.8; background-color: rgba(0,0,0,0.05); }
        
        /* Risk Colors - Simplified to 3 levels */
        .risk-0 { }
        .risk-1 { background-color: rgba(255, 243, 205, 0.5); border-bottom: 2px solid #ffecb5; } /* Low */
        .risk-3 { background-color: rgba(255, 217, 102, 0.5); border-bottom: 2px solid #ffc107; } /* Mid */
        .risk-5 { background-color: rgba(220, 53, 69, 0.2); border-bottom: 2px solid #dc3545; color: #a50e0e; } /* High */
        
        .privacy-panel { 
            background: #f8f9fa; 
            border: 1px solid #e9ecef; 
            padding: 15px; 
            border-radius: 12px; 
            margin-top: 15px; 
            width: 100%; 
            font-size: 0.9rem;
        }
        
        .loading-spinner { display: inline-block; width: 1rem; height: 1rem; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border .75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Selection & Toolbar */
        .token.selected { background-color: #cce5ff; outline: 1px solid #0d6efd; }
        .sanitized-highlight { padding: 0 2px; border-radius: 2px; }
        .restorable { border-bottom: 1px dashed #0d6efd; cursor: pointer; transition: all 0.2s; background-color: rgba(13, 110, 253, 0.1); color: #0b57d0; padding: 0 2px; border-radius: 2px; }
        .restorable:hover { background-color: rgba(13, 110, 253, 0.25); }
        .restorable.restored { background-color: rgba(25, 135, 84, 0.1); border-bottom-color: #198754; color: inherit; }
        
        /* Risk Colors for Details Panel */
        .risk-bg-1 { background-color: rgba(255, 243, 205, 0.5); border-bottom: 2px solid #ffecb5; }
        .risk-bg-3 { background-color: rgba(255, 217, 102, 0.5); border-bottom: 2px solid #ffc107; }
        .risk-bg-5 { background-color: rgba(220, 53, 69, 0.2); border-bottom: 2px solid #dc3545; color: #a50e0e; }
        
        #floatingToolbar {
            position: absolute;
            display: none;
            background: white;
            border: none;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: fadeIn 0.2s;
        }
        #floatingToolbar button {
            margin: 0 2px;
            font-size: 0.75rem;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="sidebar d-none d-md-flex">
    <button class="new-chat-btn" onclick="startNewChat()">
        <i class="bi bi-plus-lg"></i> New Chat
    </button>
    <div class="small text-muted ms-2 mb-2">Recent</div>
    <div class="history-list" id="historyList">
        <!-- History items will go here -->
    </div>
    <div class="mt-auto">
        <div class="small text-muted"><i class="bi bi-shield-lock"></i> RapLI Privacy Guard</div>
    </div>
</div>

<div class="main-content">
    <div class="top-bar">
        <div class="d-flex align-items-center w-100">
            <button class="btn btn-link text-dark d-md-none me-2"><i class="bi bi-list"></i></button>
            <div class="d-flex flex-column">
                <select class="model-selector form-select form-select-sm" id="datasetSelect" style="width: auto; min-width: 150px; font-weight: 600; border-radius: 8px;" onchange="handleDatasetChange()">
                    <option value="general">General Chat</option>
                    <option value="ag_news">AG News</option>
                    <option value="samsum">SAMSum</option>
                    <option value="spam_email">Spam Email (CN)</option>
                    <option value="user_study">User Study</option>
                </select>
                <small class="text-muted" id="taskDescription" style="font-size: 0.75rem; margin-top: 2px; margin-left: 2px;">General Chat</small>
            </div>
        </div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="welcome-screen" id="welcomeScreen">
            <div class="welcome-text">RapLI Privacy Guard</div>
            <div class="mb-4 text-muted">
                <p class="fs-5">Risk-Aware Privacy Preservation for LLM Inference / é£é™©æ„ŸçŸ¥çš„å¤§æ¨¡å‹æ¨ç†éšç§ä¿æŠ¤</p>
            </div>
            
            <div class="card border-0 shadow-sm mb-4" style="max-width: 1000px; width: 100%; text-align: left; background: #f8f9fa;">
                <div class="card-body d-flex align-items-start gap-3">
                    <i class="bi bi-shield-check fs-2 text-primary mt-1"></i>
                    <div>
                        <p class="mb-2" style="color: #444746;">
                            <strong>RapLI</strong> acts as a secure shield between you and LLMs. It intelligently identifies and masks sensitive personal information (PII) in your inputs, allowing you to safely use cloud-based AI services without data leakage risks.
                        </p>
                        <p class="mb-0 small text-muted">
                            <strong>RapLI</strong> æ˜¯æ‚¨ä¸å¤§æ¨¡å‹ä¹‹é—´çš„å®‰å…¨æŠ¤ç›¾ã€‚å®ƒèƒ½æ™ºèƒ½è¯†åˆ«å¹¶æ©ç›–è¾“å…¥ä¸­çš„æ•æ„Ÿä¸ªäººä¿¡æ¯ï¼ˆPIIï¼‰ï¼Œè®©æ‚¨åœ¨å®‰å…¨ä½¿ç”¨äº‘ç«¯ AI æœåŠ¡çš„åŒæ—¶ï¼Œä¿æŠ¤æ‚¨çš„éšç§ã€‚
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="card border-0 shadow-sm" style="max-width: 1000px; width: 100%; text-align: left;">
                <div class="card-body">
                    <h6 class="card-title fw-bold"><i class="bi bi-info-circle me-2"></i>How it works / å¦‚ä½•ä½¿ç”¨</h6>
                    <ol class="list-group list-group-numbered list-group-flush small">
                        <li class="list-group-item border-0">
                            <strong>Select Scenario:</strong> Choose a dataset/task from the top dropdown (e.g., Spam Email, General Chat).<br>
                            <span class="text-muted">é€‰æ‹©åœºæ™¯ï¼šåœ¨é¡¶éƒ¨ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªæ•°æ®é›†æˆ–ä»»åŠ¡ï¼ˆå¦‚åƒåœ¾é‚®ä»¶ã€é€šç”¨å¯¹è¯ï¼‰ã€‚</span>
                        </li>
                        <li class="list-group-item border-0">
                            <strong>Input Text:</strong> Type or paste your text below and click Send.<br>
                            <span class="text-muted">è¾“å…¥æ–‡æœ¬ï¼šåœ¨ä¸‹æ–¹è¾“å…¥æ¡†è¾“å…¥æˆ–ç²˜è´´æ–‡æœ¬ï¼Œç‚¹å‡»å‘é€ã€‚</span>
                        </li>
                        <li class="list-group-item border-0">
                            <strong>Review & Edit:</strong> RapLI detects and highlights  PII. You can manually adjust risk levels in the popup.<br>
                            <span class="text-muted">å®¡æŸ¥ä¸ç¼–è¾‘ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å¹¶é«˜äº®éšç§ä¿¡æ¯ã€‚æ‚¨å¯ä»¥åœ¨å¼¹çª—ä¸­æ‰‹åŠ¨è°ƒæ•´é£é™©ç­‰çº§ã€‚</span>
                        </li>
                        <li class="list-group-item border-0">
                            <strong>Sanitize & Chat:</strong> Confirm to sanitize the text and send it to the LLM.<br>
                            <span class="text-muted">è„±æ•ä¸å¯¹è¯ï¼šç¡®è®¤åï¼Œç³»ç»Ÿå°†å¯¹æ–‡æœ¬è¿›è¡Œè„±æ•å¹¶å‘é€ç»™å¤§æ¨¡å‹ã€‚</span>
                        </li>
                        <li class="list-group-item border-0">
                            <strong>Restore Locally:</strong> Click "Restore All" to restore the perturbed information in the response locally.<br>
                            <span class="text-muted">æœ¬åœ°è¿˜åŸï¼šç‚¹å‡»â€œä¸€é”®è¿˜åŸâ€å³å¯åœ¨æœ¬åœ°å°†å¤§æ¨¡å‹å“åº”ä¸­çš„æ‰°åŠ¨ä¿¡æ¯è¿˜åŸã€‚</span>
                        </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="input-area">
        <div class="input-container">
            <textarea class="form-control" id="userInput" rows="1" placeholder="Type a message..." oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
            <button class="send-btn" onclick="processInput()" id="sendBtn">
                <i class="bi bi-send-fill fs-5"></i>
            </button>
        </div>
        <div class="text-center mt-2">
            <small class="text-muted" style="font-size: 0.7rem;">RapLI may display inaccurate info, so double-check its responses.</small>
        </div>
    </div>
</div>

<!-- Privacy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog" style="max-width: 70%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Privacy Check</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body position-relative">
                <div class="alert alert-light border-start border-4 border-primary" role="alert">
                    <h6 class="alert-heading fw-bold small"><i class="bi bi-magic me-2"></i>Interactive Privacy Control / äº¤äº’å¼éšç§æ§åˆ¶</h6>
                    <p class="mb-0 small text-muted">
                        1. <strong>Click</strong> to select tokens. <strong>Shift+Click</strong> to select a range.<br>
                        2. Use the <strong>Toolbar</strong> to assign risk levels (Safe/Low/Mid/High).<br>
                        3. <strong>High Risk</strong> items are heavily obfuscated. <strong>Safe</strong> items are kept as is.<br>
                        <hr class="my-1">
                        1. <strong>ç‚¹å‡»</strong>é€‰ä¸­è¯å—ã€‚<strong>Shift+ç‚¹å‡»</strong>é€‰ä¸­èŒƒå›´ã€‚<br>
                        2. ä½¿ç”¨<strong>å·¥å…·æ </strong>è®¾ç½®é£é™©ç­‰çº§ï¼ˆå®‰å…¨/ä½/ä¸­/é«˜ï¼‰ã€‚<br>
                        3. <strong>é«˜é£é™©</strong>å†…å®¹å°†è¢«é‡åº¦æ··æ·†ï¼Œ<strong>å®‰å…¨</strong>å†…å®¹ä¿æŒä¸å˜ã€‚
                    </p>
                </div>
                <div id="tokenContainer" class="border p-3 rounded mb-3" style="line-height: 2.0; font-size: 1.1em;"></div>
                
                <!-- Floating Toolbar -->
                <div id="floatingToolbar">
                    <button class="btn btn-sm btn-outline-secondary" onclick="setRiskForSelection(0)">Safe</button>
                    <button class="btn btn-sm btn-warning" style="background-color: #fff3cd; border-color: #ffecb5;" onclick="setRiskForSelection(1)">Low</button>
                    <button class="btn btn-sm btn-warning" style="background-color: #ffd966; border-color: #ffc107;" onclick="setRiskForSelection(3)">Mid</button>
                    <button class="btn btn-sm btn-danger" onclick="setRiskForSelection(5)">High</button>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <div id="analysisMetrics" class="small text-muted"></div>
                    <div>
                        <span class="badge bg-danger">High</span>
                        <span class="badge bg-warning text-dark">Mid</span>
                        <span class="badge bg-warning text-dark" style="opacity: 0.6;">Low</span>
                        <span class="badge bg-light text-dark border">Safe</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary me-auto" onclick="resetRisk()">Reset Default</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmPrivacy()">Confirm & Send</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentTokens = [];
    let currentVisualTokens = [];
    let initialTokensState = [];
    let initialVisualTokensState = [];
    let currentText = "";
    let currentTimings = {}; // Store analysis timings
    let selectedIndices = new Set();
    let lastClickedIndex = -1;
    let manualStartTime = 0;
    let msgCounter = 0;
    let currentSessionId = null;
    let sessions = {}; // { id: { id, title, timestamp, messages: [] } }
    let userId = localStorage.getItem('rapli_user_id');
    if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('rapli_user_id', userId);
    }
    
    const privacyModal = new bootstrap.Modal(document.getElementById('privacyModal'));

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadSessionsFromStorage();
        renderSidebar();
        updateTaskDescription();
        
        // Auto-resize textarea
        const tx = document.getElementById('userInput');
        tx.addEventListener("input", function(){
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + "px";
        });
        // Enter to send
        tx.addEventListener("keydown", function(e){
            if(e.key === 'Enter' && !e.shiftKey){
                e.preventDefault();
                processInput();
            }
        });
    });

    function loadSessionsFromStorage() {
        try {
            sessions = JSON.parse(localStorage.getItem('rapli_sessions') || '{}');
        } catch(e) {
            sessions = {};
        }
    }

    function saveSessionsToStorage() {
        localStorage.setItem('rapli_sessions', JSON.stringify(sessions));
        renderSidebar();
    }

    function startNewChat() {
        currentSessionId = null;
        document.getElementById('chatContainer').innerHTML = `
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-text">RapLI Privacy Guard</div>
                <div class="mb-4 text-muted">
                    <p class="fs-5">Risk-Aware Privacy Preservation for LLM Inference / é£é™©æ„ŸçŸ¥çš„å¤§æ¨¡å‹æ¨ç†éšç§ä¿æŠ¤</p>
                </div>
                
                <div class="card border-0 shadow-sm mb-4" style="max-width: 1000px; width: 100%; text-align: left; background: #f8f9fa;">
                    <div class="card-body d-flex align-items-start gap-3">
                        <i class="bi bi-shield-check fs-2 text-primary mt-1"></i>
                        <div>
                            <p class="mb-2" style="color: #444746;">
                                <strong>RapLI</strong> acts as a secure shield between you and LLMs. It intelligently identifies and masks sensitive personal information (PII) in your inputs, allowing you to safely use cloud-based AI services without data leakage risks.
                            </p>
                            <p class="mb-0 small text-muted">
                                <strong>RapLI</strong> æ˜¯æ‚¨ä¸å¤§æ¨¡å‹ä¹‹é—´çš„å®‰å…¨æŠ¤ç›¾ã€‚å®ƒèƒ½æ™ºèƒ½è¯†åˆ«å¹¶æ©ç›–è¾“å…¥ä¸­çš„æ•æ„Ÿä¸ªäººä¿¡æ¯ï¼ˆPIIï¼‰ï¼Œè®©æ‚¨åœ¨å®‰å…¨ä½¿ç”¨äº‘ç«¯ AI æœåŠ¡çš„åŒæ—¶ï¼Œä¿æŠ¤æ‚¨çš„éšç§ã€‚
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="card border-0 shadow-sm" style="max-width: 1000px; width: 100%; text-align: left;">
                    <div class="card-body">
                        <h6 class="card-title fw-bold"><i class="bi bi-info-circle me-2"></i>How it works / å¦‚ä½•ä½¿ç”¨</h6>
                        <ol class="list-group list-group-numbered list-group-flush small">
                            <li class="list-group-item border-0">
                            <strong>Select Scenario:</strong> Choose a dataset/task from the top dropdown (e.g., Spam Email, General Chat).<br>
                            <span class="text-muted">é€‰æ‹©åœºæ™¯ï¼šåœ¨é¡¶éƒ¨ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªæ•°æ®é›†æˆ–ä»»åŠ¡ï¼ˆå¦‚åƒåœ¾é‚®ä»¶ã€é€šç”¨å¯¹è¯ï¼‰ã€‚</span>
                            </li>
                            <li class="list-group-item border-0">
                                <strong>Input Text:</strong> Type or paste your text below and click Send.<br>
                                <span class="text-muted">è¾“å…¥æ–‡æœ¬ï¼šåœ¨ä¸‹æ–¹è¾“å…¥æ¡†è¾“å…¥æˆ–ç²˜è´´æ–‡æœ¬ï¼Œç‚¹å‡»å‘é€ã€‚</span>
                            </li>
                            <li class="list-group-item border-0">
                                <strong>Review & Edit:</strong> RapLI detects and highlights  PII. You can manually adjust risk levels in the popup.<br>
                                <span class="text-muted">å®¡æŸ¥ä¸ç¼–è¾‘ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å¹¶é«˜äº®éšç§ä¿¡æ¯ã€‚æ‚¨å¯ä»¥åœ¨å¼¹çª—ä¸­æ‰‹åŠ¨è°ƒæ•´é£é™©ç­‰çº§ã€‚</span>
                            </li>
                            <li class="list-group-item border-0">
                                <strong>Sanitize & Chat:</strong> Confirm to sanitize the text and send it to the LLM.<br>
                                <span class="text-muted">è„±æ•ä¸å¯¹è¯ï¼šç¡®è®¤åï¼Œç³»ç»Ÿå°†å¯¹æ–‡æœ¬è¿›è¡Œè„±æ•å¹¶å‘é€ç»™å¤§æ¨¡å‹ã€‚</span>
                            </li>
                            <li class="list-group-item border-0">
                                <strong>Restore Locally:</strong> Click "Restore All" to restore the perturbed information in the response locally.<br>
                                <span class="text-muted">æœ¬åœ°è¿˜åŸï¼šç‚¹å‡»â€œä¸€é”®è¿˜åŸâ€å³å¯åœ¨æœ¬åœ°å°†å¤§æ¨¡å‹å“åº”ä¸­çš„æ‰°åŠ¨ä¿¡æ¯è¿˜åŸã€‚</span>
                            </li>
                        </ol>
                    </div>
                </div>
            </div>
        `;
        currentText = "";
        currentTokens = [];
        currentTimings = {};
        msgCounter = 0;
        
        // Update active state
        document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
    }

    function renderSidebar() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        
        // Sort sessions by timestamp desc
        const sortedSessions = Object.values(sessions).sort((a, b) => b.timestamp - a.timestamp);
        
        sortedSessions.forEach(session => {
            const div = document.createElement('div');
            div.className = `history-item ${session.id === currentSessionId ? 'active' : ''}`;
            div.onclick = () => loadSession(session.id);
            
            div.innerHTML = `
                <span class="title"><i class="bi bi-chat-left-text me-2"></i>${session.title}</span>
                <div class="actions">
                    <button class="action-btn" onclick="renameSession('${session.id}', event)" title="Rename">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteSession('${session.id}', event)" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function renameSession(id, event) {
        event.stopPropagation();
        const session = sessions[id];
        if (!session) return;
        
        const newTitle = prompt("Rename chat / é‡å‘½åå¯¹è¯:", session.title);
        if (newTitle && newTitle.trim() !== "") {
            session.title = newTitle.trim();
            saveSessionsToStorage();
        }
    }

    function loadSession(id) {
        if (!sessions[id]) return;
        currentSessionId = id;
        
        const container = document.getElementById('chatContainer');
        container.innerHTML = ''; // Clear current
        
        sessions[id].messages.forEach(msg => {
            // Re-render message
            // Note: We don't have the loading state here, just final content
            addMessage(msg.content, msg.role, false);
        });
        
        renderSidebar(); // Update active class
    }

    function deleteSession(id, event) {
        event.stopPropagation(); // Prevent click on item
        if (confirm('Delete this chat?')) {
            delete sessions[id];
            saveSessionsToStorage();
            if (currentSessionId === id) {
                startNewChat();
            }
        }
    }

    function appendMessageToCurrentSession(role, content) {
        if (!currentSessionId) {
            currentSessionId = Date.now().toString();
            sessions[currentSessionId] = {
                id: currentSessionId,
                title: role === 'user' ? (content.length > 20 ? content.substring(0, 20) + '...' : content) : 'New Chat',
                timestamp: Date.now(),
                messages: []
            };
        }
        
        // Update title if it's 'New Chat' and this is user message
        if (sessions[currentSessionId].title === 'New Chat' && role === 'user') {
             sessions[currentSessionId].title = content.length > 20 ? content.substring(0, 20) + '...' : content;
        }

        sessions[currentSessionId].messages.push({ role, content, timestamp: Date.now() });
        sessions[currentSessionId].timestamp = Date.now(); // Update last modified
        saveSessionsToStorage();
    }

    // Removed old loadHistory/addToHistory functions

    const taskDescriptions = {
        'general': 'General Chat / é€šç”¨å¯¹è¯ (Multilingual)',
        'ag_news': 'Topic Classification / æ–°é—»ä¸»é¢˜åˆ†ç±» (World, Sports, Business, Sci/Tech)',
        'samsum': 'Dialogue Summarization / å¯¹è¯æ‘˜è¦',
        'spam_email': 'Spam Detection / åƒåœ¾é‚®ä»¶æ£€æµ‹ (Chinese)',
        'user_study': 'User Study Mode / ç”¨æˆ·å®éªŒæ¨¡å¼',
        'translate': 'Translation / ç¿»è¯‘ä»»åŠ¡'
    };

    // User Study Configuration
    const userStudyCases = [
        { dataset: 'ag_news', text: `Paul McCartney to perform at Super Bowl The organisers of the half-time entertainment for next year #39;s Super Bowl have signed a deal with Sir Paul McCartney to entertain millions.` },
        { dataset: 'ag_news', text: `In Brief: NetSuite integrates with WorldPay to boost e-commerce NetSuite has unveiled the availability of multicurrency credit card processing for its e-commerce customers. The new feature was made possible by integration, announced this week, between NetSuite and WorldPay, which is part of The Royal Bank of Scotland Group. NetSuite's e-commerce capability enables companies to transact business on the Web while automatically linking into internal customer relationship management, financial, and warehouse systems. With the new multicurrency credit card processing feature, NetSuite e-commerce customers can now accept credit card payments in 120 currencies and receive settlement in 14 currencies. More information about NetSuite e-commerce is available at www.netsuite.com/netcommerce1.` },
        { dataset: 'samsum', text: `Jonas: Iâ€™m running 10 minutes late. Could you guys just let Mary know that Iâ€™m coming and will present today before she starts?
        Natalie: Sure no problem
        Olivia: Iâ€™ll save a seat for you ğŸ˜ 
        Jonas: Thanks so much. See you in a bit xx` },
        { dataset: 'samsum', text: `Client: Good afternoon. I suggest you adjust the timetable to the reality on the Polish roads. P6 bus Radom - Warsaw, arriving from Cracow, 40 minutes delay.
        Client: And it was not the first time, there was one hour delay not so long ago...
        Flix: Hi Marta. We are very sorry that the bus arrived late, but they are operational delays which we have no control over. Apologies.
        Client: But this happens too often. Why don't you consider rearranging the timetable??
        Client: I was waiting at the station from 17.10, hoping to get the bus at 17.25. It arrived at 18.10. One hour waiting.
        Client: It hardly ever happens that the bus arrives on time. The timetable is too optimistic. I understand there are traffic jams but...
        Flix: Thank you for the information, we will inform our managers about it.
        Client: Can I make a formal complaint? I had a similar situation last year.
        Flix: Sure, you can send a complaint by email to info@flix.com.
        Client: thanks, I will definitely. But I really hope you do something about it this time...
        Flix: yes, all complaints are addressed by our managers.
        Client: great. They should not just read them, but do something about it. Will you inform me about the status?
        Flix: We don't do that automatically, but you can call us and find out. You can find all the necessary info on our website.
        Client: Ok, I see.
        Flix: Once again apologies.` },
        { dataset: 'spam_email', text: `æ­å–œæ‚¨è·å¾—ã€é™æ—¶100å…ƒç°é‡‘çº¢åŒ…ã€‘ï¼ç‚¹å‡»é“¾æ¥ç«‹å³é¢†å–ï¼šhttps://example.com/redpacket  ğŸ”¥çˆ†æ¬¾å•†å“é™æ—¶5æŠ˜ï¼šhttps://example.com/sale ğŸ”¥æŠ•èµ„å›æŠ¥ç‡35%é¡¹ç›®ï¼šhttps://example.com/investment  âš ï¸æœ¬æ´»åŠ¨ä»…é™24å°æ—¶å†…å‚ä¸ï¼Œé€¾æœŸå¤±æ•ˆï¼` },
        { dataset: 'spam_email', text: `ğŸ“§ å…³äºæäº¤2023å¹´ç¬¬å››å­£åº¦å·®æ—…è´¹ç”¨æŠ¥é”€å•çš„é€šçŸ¥
        å‘é€ï¼š è´¢åŠ¡éƒ¨
        æ¥æ”¶ï¼š å¼ ä¼Ÿ
        æ—¥æœŸï¼š 2025å¹´12æœˆ3æ—¥

        ä¸»é¢˜ï¼š ğŸ“… é‡è¦é€šçŸ¥ï¼šè¯·åŠæ—¶æäº¤2023å¹´ç¬¬å››å­£åº¦å·®æ—…è´¹ç”¨æŠ¥é”€å•ï¼ˆæˆªæ­¢æ—¥æœŸï¼š12æœˆ8æ—¥ï¼‰

        äº²çˆ±çš„ å¼ ä¼Ÿ å…ˆç”Ÿ/å¥³å£«ï¼š

        æ‚¨å¥½ï¼

        ä¸ºç¡®ä¿å…¬å¸è´¢åŠ¡æµç¨‹çš„é¡ºç•…è¿›è¡Œï¼Œå¹¶æŒ‰ç…§å¹´åº¦ç»“è´¦å·¥ä½œçš„ç»Ÿä¸€å®‰æ’ï¼Œè´¢åŠ¡éƒ¨ç°æ­£å¼å¯åŠ¨2023å¹´ç¬¬å››å­£åº¦ï¼ˆ10æœˆ1æ—¥è‡³12æœˆ31æ—¥ï¼‰çš„å·®æ—…è´¹ç”¨æŠ¥é”€å·¥ä½œã€‚

        ğŸ—“ï¸ æˆªæ­¢æ—¥æœŸåŠè¦æ±‚
        è¯·æ‚¨åŠ¡å¿…åœ¨ 2025å¹´12æœˆ8æ—¥ ä¸‹ç­å‰ï¼Œå°†æ‚¨åœ¨æœ¬å­£åº¦äº§ç”Ÿçš„æ‰€æœ‰å·®æ—…è´¹ç”¨æŠ¥é”€å•æ®å®Œæ•´æäº¤è‡³è´¢åŠ¡éƒ¨è¿›è¡Œå®¡æ ¸å’Œå¤„ç†ã€‚

        ğŸ“‹ å…·ä½“æŠ¥é”€è¦æ±‚
        ä¸ºäº†åŠ é€ŸæŠ¥é”€å®¡æ‰¹æµç¨‹ï¼Œè¯·æ‚¨ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ä¸‰ç‚¹è¦æ±‚å‡†å¤‡å¹¶æäº¤æŠ¥é”€ææ–™ï¼š

        ç¥¨æ®å‡­è¯ï¼ˆæ ¸å¿ƒè¦ç‚¹ï¼‰ï¼š è¯·æ‚¨ç¡®ä¿æ‰€æœ‰è´¹ç”¨ç¥¨æ®çš„åˆè§„æ€§ã€‚å¯¹äºç”µå­å‘ç¥¨ï¼Œè¯·åŠ¡å¿…æä¾›å…¶ç”µå­åŸä»¶ï¼ˆPDFæˆ–OFDæ ¼å¼ï¼‰ï¼Œå¹¶é™„ä¸Šç›¸åº”çš„äº¤æ˜“è®°å½•æˆ–è¡Œç¨‹è¯æ˜ã€‚å¯¹äºçº¸è´¨å‘ç¥¨ï¼Œè¯·ä¿è¯ç¥¨æ®æ¸…æ™°ã€å®Œæ•´ã€‚

        æŠ¥é”€äº‹ç”±åŠé‡‘é¢ï¼š è¯·åœ¨æŠ¥é”€å•ä¸Šæ¸…æ™°ã€å®Œæ•´åœ°è¯´æ˜æ¯ä¸€ç¬”è´¹ç”¨çš„æŠ¥é”€äº‹ç”±ï¼ˆä¾‹å¦‚ï¼šå‡ºå·®ç›®çš„åœ°ã€é¡¹ç›®åç§°ã€æ—¥æœŸèŒƒå›´ï¼‰ä»¥åŠå¯¹åº”çš„å‡†ç¡®é‡‘é¢ã€‚è¿™å°†æœ‰åŠ©äºæˆ‘ä»¬è¿›è¡Œå†…éƒ¨æˆæœ¬æ ¸ç®—ä¸é¡¹ç›®åŒ¹é…ã€‚

        æ¨¡æ¿ä½¿ç”¨è§„èŒƒï¼š è¯·æ‚¨åŠ¡å¿…ä½¿ç”¨é‚®ä»¶é™„ä»¶ä¸­æä¾›çš„æœ€æ–°ç‰ˆã€Š2023Q4æŠ¥é”€æ¨¡æ¿.xlsxã€‹è¿›è¡Œå¡«å†™ã€‚è¯·å‹¿è‡ªè¡Œæ›´æ”¹æ¨¡æ¿æ ¼å¼ï¼Œå¹¶ç¡®ä¿æ‰€æœ‰ä¿¡æ¯å¡«å†™å‡†ç¡®æ— è¯¯ã€‚

        ğŸ’¡ é‡è¦æé†’
        è¶…æ—¶æäº¤ï¼š 12æœˆ8æ—¥ä¸ºæœ¬å­£åº¦æŠ¥é”€çš„æœ€ç»ˆæˆªæ­¢æ—¥æœŸã€‚é€¾æœŸæäº¤çš„æŠ¥é”€å•ï¼Œå¯èƒ½éœ€è¦ç­‰åˆ°ä¸‹ä¸€è½®ï¼ˆå³æ˜å¹´ç¬¬ä¸€å­£åº¦ï¼‰çš„é›†ä¸­å¤„ç†ï¼Œè¿™å¯èƒ½ä¼šå»¶è¯¯æ‚¨çš„æ¬¾é¡¹åˆ°è´¦æ—¶é—´ã€‚

        é™„ä»¶ä¸‹è½½ï¼š è¯·æ³¨æ„ä¸‹è½½å¹¶ä½¿ç”¨æœ¬é‚®ä»¶éšé™„çš„**ã€Š2023Q4æŠ¥é”€æ¨¡æ¿.xlsxã€‹**ã€‚

        å¦‚æœ‰ä»»ä½•å…³äºæŠ¥é”€æµç¨‹ã€æ”¿ç­–æˆ–æ¨¡æ¿å¡«å†™æ–¹é¢çš„ç–‘é—®ï¼Œè¯·éšæ—¶è”ç³»è´¢åŠ¡éƒ¨çš„ ç‹è‰ åŒäº‹ï¼Œå¥¹å°†ä¸ºæ‚¨æä¾›å¿…è¦çš„ååŠ©ã€‚

        è”ç³»äººï¼š ç‹è‰

        ç”µè¯ï¼š 13812345678

        æ„Ÿè°¢æ‚¨çš„ç†è§£ä¸é…åˆï¼ç¥æ‚¨å·¥ä½œé¡ºåˆ©ï¼

        æ­¤è‡´ï¼Œ

        [é™„ä»¶ï¼š2023Q4æŠ¥é”€æ¨¡æ¿.xlsx]

        è´¢åŠ¡éƒ¨ æ•¬ä¸Š` },
        
        { dataset: 'general', text: `æˆ‘éœ€è¦å‘çºªå¾‹æ£€æŸ¥å§”å‘˜ä¼šå’Œç›‘å¯Ÿå§”å‘˜ä¼šå‘é€é‚®ä»¶ï¼Œè¡¨è¾¾å¯¹å¸‚åœºç›‘ç£ç®¡ç†å±€åŠå…¬å®¤ä¸»ä»»å¼ ä¸‰å·¥ä½œçš„ä¸æ»¡ï¼Œå…¶æ¶‰å«Œæ•²è¯ˆå‹’ç´¢ã€å‹’ç´¢è´¢ç‰©ç­‰è¿æ³•è¡Œä¸ºã€‚è¯·ååŠ©æˆ‘èµ·è‰æŠ•è¯‰ä¿¡å¹¶ç•™ä¸‹æˆ‘çš„è”ç³»æ–¹å¼18263728192ã€‚` },
        { dataset: 'general', text: `ä½ å¥½ï¼Œæˆ‘æ˜¯å®‰å¾½çœé˜œé˜³å¸‚å…¬å®‰å±€äº¤è­¦æ”¯é˜Ÿçš„å‘˜å·¥ï¼Œæˆ‘éœ€è¦å‘çºªå¾‹æ£€æŸ¥å§”å‘˜ä¼šå’Œç›‘å¯Ÿå§”å‘˜ä¼šå‘é€é‚®ä»¶ï¼Œè¡¨è¾¾å¯¹é˜œé˜³å¸‚æ‰§æ³•å·¥ä½œçš„ä¸æ»¡ï¼Œè¯·ååŠ©æˆ‘èµ·è‰æŠ•è¯‰ä¿¡ã€‚æŠ•è¯‰å¯¹è±¡æ˜¯å¸‚åœºç›‘ç£ç®¡ç†å±€åŠå…¬å®¤ä¸»ä»»å¼ ä¸‰ï¼Œå…¶æ¶‰å«Œæ•²è¯ˆå‹’ç´¢ã€å‹’ç´¢è´¢ç‰©åŠéæ³•æ”¶å—ä»–äººè´¢ç‰©ç­‰è¿æ³•è¡Œä¸ºï¼Œä¸»è¦è¡Œè´¿äººä¸ºæ›¹å››ï¼Œä»–ä»¬ä¸¤ä¸ªäººæ˜¯åˆä¸­åŒå­¦å…³ç³»ï¼Œå…¶è¡Œè´¿é‡‘é¢é«˜è¾¾200ä¸‡äººæ°‘å¸ã€‚æ³¨æ„ï¼Œè¯·æ ‡æ˜å°†åé¦ˆé‚®ä»¶å‘é€åˆ°821738128@qq.comï¼Œæ”¶ä»¶äººç‹å½¬å½¬ï¼Œé€šè®¯åœ°å€å®‰å¾½çœé˜œé˜³å¸‚æœé˜³è¡—é“724å·ï¼Œè”ç³»ç”µè¯1928231992ã€‚` },
        { dataset: 'translate', text: `Kattie could you please share your recomndations about vegetarian diet for 72 old Intersex person with 158 centimeters?` },
        { dataset: 'translate', text: `Dear Dr. Golda, I'm from the Design Department at Strosin Group, as the Producer, I have been overseeing the branding management process. I saw you recently visited our webpage https://gruesome-fries.biz/ and showed some interest in our brand. Recently, we launched a mobile application, we suggest you try it out, using the username: Meagan.Franecki41, and password: GykiU96318kb. The Brand management team has received your application for the auto-loan. The Account name is Auto Loan Account, the account number 87008424, and the transaction amount to be debited is Q355k.` }
    ];
    
    let isUserStudyMode = false;
    let userStudyIndex = 0;

    function handleDatasetChange() {
        const val = document.getElementById('datasetSelect').value;
        
        if (val === 'user_study') {
            isUserStudyMode = true;
            userStudyIndex = 0;
            loadUserStudyCase();
        } else {
            isUserStudyMode = false;
            updateTaskDescription();
        }
    }

    function loadUserStudyCase() {
        if (userStudyIndex >= userStudyCases.length) {
            alert("User Study Completed! Thank you.");
            document.getElementById('datasetSelect').value = 'general';
            handleDatasetChange();
            return;
        }
        
        const currentCase = userStudyCases[userStudyIndex];
        document.getElementById('userInput').value = currentCase.text;
        document.getElementById('userInput').style.height = 'auto';
        document.getElementById('userInput').style.height = document.getElementById('userInput').scrollHeight + 'px';
        
        document.getElementById('taskDescription').innerText = `User Study (${userStudyIndex + 1}/${userStudyCases.length}): ${taskDescriptions[currentCase.dataset]}`;
    }

    function updateTaskDescription() {
        const val = document.getElementById('datasetSelect').value;
        const desc = taskDescriptions[val] || '';
        document.getElementById('taskDescription').innerText = desc;
    }

    async function processInput() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text) return;
        
        currentText = text;
        
        // Show loading
        const sendBtn = document.querySelector('button[onclick="processInput()"]');
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="loading-spinner"></span>';

        try {
            const selectedDataset = document.getElementById('datasetSelect').value;
            const dataset = isUserStudyMode ? userStudyCases[userStudyIndex].dataset : selectedDataset;

            const res = await fetch('/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    text,
                    dataset: dataset
                })
            });
            const data = await res.json();
            
            if (data.error) {
                alert(data.error);
                return;
            }

            currentTokens = data.tokens;
            currentVisualTokens = data.visual_tokens || [];
            
            initialTokensState = JSON.parse(JSON.stringify(currentTokens));
            initialVisualTokensState = JSON.parse(JSON.stringify(currentVisualTokens));
            
            selectedIndices.clear();
            lastClickedIndex = -1;
            renderTokens();
            
            // Store timings for later use
            currentTimings = data.timings;
            
            // Update metrics - Hidden as per request, moved to final stats
            document.getElementById('analysisMetrics').innerHTML = '';
            
            manualStartTime = Date.now();
            privacyModal.show();
            
        } catch (e) {
            console.error(e);
            alert('Error processing text');
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerText = 'Send';
        }
    }

    function resetRisk() {
        if (initialTokensState.length === 0) return;
        currentTokens = JSON.parse(JSON.stringify(initialTokensState));
        currentVisualTokens = JSON.parse(JSON.stringify(initialVisualTokensState));
        selectedIndices.clear();
        renderTokens();
    }

    function renderTokens() {
        const container = document.getElementById('tokenContainer');
        container.innerHTML = '';
        
        // Use visual tokens if available, otherwise fallback to tokens
        const items = currentVisualTokens.length > 0 ? currentVisualTokens : currentTokens;
        
        items.forEach((t, idx) => {
            // Render gap before if exists
            if (t.gap_before) {
                const gapSpan = document.createElement('span');
                gapSpan.innerText = t.gap_before;
                container.appendChild(gapSpan);
            }

            const span = document.createElement('span');
            // Check if any token in this group is selected
            const isSelected = t.token_indices ? t.token_indices.some(i => selectedIndices.has(i)) : selectedIndices.has(t.index);
            
            span.className = `token risk-${t.risk_level} ${isSelected ? 'selected' : ''}`;
            span.innerText = t.text;
            
            // Store the first index for reference
            const firstIndex = t.token_indices ? t.token_indices[0] : t.index;
            span.dataset.index = firstIndex;
            span.dataset.visualIndex = idx; // Store visual index for range selection
            
            span.onclick = (e) => handleTokenClick(e, idx);
            container.appendChild(span);
            
            // Render gap after if exists (for last token)
            if (t.gap_after) {
                const gapSpan = document.createElement('span');
                gapSpan.innerText = t.gap_after;
                container.appendChild(gapSpan);
            }
        });
        
        updateToolbar();
    }

    function handleTokenClick(e, visualIndex) {
        const items = currentVisualTokens.length > 0 ? currentVisualTokens : currentTokens;
        
        if (e.shiftKey && lastClickedIndex !== -1) {
            // Range select based on visual index
            const start = Math.min(lastClickedIndex, visualIndex);
            const end = Math.max(lastClickedIndex, visualIndex);
            
            for (let i = start; i <= end; i++) {
                const item = items[i];
                const indices = item.token_indices || [item.index];
                indices.forEach(idx => selectedIndices.add(idx));
            }
        } else {
            // Toggle selection for this visual item
            const item = items[visualIndex];
            const indices = item.token_indices || [item.index];
            
            // Check if fully selected
            const allSelected = indices.every(idx => selectedIndices.has(idx));
            
            if (allSelected) {
                indices.forEach(idx => selectedIndices.delete(idx));
            } else {
                indices.forEach(idx => selectedIndices.add(idx));
            }
            lastClickedIndex = visualIndex;
        }
        renderTokens();
    }

    function updateToolbar() {
        const toolbar = document.getElementById('floatingToolbar');
        if (selectedIndices.size > 0) {
            // Position toolbar near the last clicked element
            // We need to find the DOM element corresponding to lastClickedIndex (visual index)
            // But lastClickedIndex is visual index now.
            
            // Find element with data-visual-index
            const lastEl = document.querySelector(`.token[data-visual-index="${lastClickedIndex}"]`);
            
            if (lastEl) {
                toolbar.style.display = 'block';
                toolbar.style.top = (lastEl.offsetTop - 40) + 'px';
                toolbar.style.left = lastEl.offsetLeft + 'px';
            } else {
                 // Fallback if lastClickedIndex is invalid or reset
                 toolbar.style.display = 'none';
            }
        } else {
            toolbar.style.display = 'none';
        }
    }

    function setRiskForSelection(level) {
        // Update risk for all selected tokens in currentTokens
        selectedIndices.forEach(idx => {
            const token = currentTokens.find(t => t.index === idx);
            if (token) token.risk_level = level;
        });
        
        // Also update visual tokens risk level for display
        currentVisualTokens.forEach(vt => {
            // If any of its tokens are in selectedIndices, update its risk?
            // Or rather, re-calculate risk from underlying tokens?
            // Simpler: just update the visual token risk if all its tokens are set to level.
            // Actually, renderTokens uses vt.risk_level. We need to sync.
            
            // Re-calculate max risk for visual token from underlying tokens
            let maxRisk = 0;
            vt.token_indices.forEach(idx => {
                const t = currentTokens.find(x => x.index === idx);
                if (t && t.risk_level > maxRisk) maxRisk = t.risk_level;
            });
            vt.risk_level = maxRisk;
        });

        selectedIndices.clear();
        renderTokens();
    }

    async function confirmPrivacy() {
        const manualEndTime = Date.now();
        const manualDuration = (manualEndTime - manualStartTime) / 1000; // seconds
        
        privacyModal.hide();
        
        // Add user message to chat UI
        addMessage(currentText, 'user');
        
        // Save User Message to Session
        appendMessageToCurrentSession('user', currentText);

        document.getElementById('userInput').value = '';
        document.getElementById('userInput').style.height = 'auto'; // Reset height
        
        // Create risk map
        const tokenRiskMap = {};
        currentTokens.forEach(t => {
            tokenRiskMap[t.index] = t.risk_level;
        });

        // Add placeholder bot message
        const botMsgId = addMessage('Sanitizing text...', 'bot', true);

        try {
            const selectedDataset = document.getElementById('datasetSelect').value;
            const dataset = isUserStudyMode ? userStudyCases[userStudyIndex].dataset : selectedDataset;

            // 1. Perturb
            const perturbRes = await fetch('/perturb', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    text: currentText,
                    token_risk_map: tokenRiskMap,
                    manual_time: manualDuration,
                    dataset: dataset
                })
            });
            
            if (!perturbRes.ok) {
                throw new Error(`Perturbation failed: ${perturbRes.status}`);
            }

            const perturbData = await perturbRes.json();
            
            updateMessage(botMsgId, 'Sending to LLM...');
            
            // 2. Send to LLM
            
            // Calculate adjustment count (number of tokens with changed risk)
            let adjustmentCount = 0;
            currentTokens.forEach((t, i) => {
                const initial = initialTokensState.find(it => it.index === t.index);
                if (initial && initial.risk_level !== t.risk_level) {
                    adjustmentCount++;
                }
            });

            const chatRes = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    message: perturbData.perturbed_text,
                    dataset: dataset,
                    user_id: userId,
                    // Extra metadata for logging
                    original_text: perturbData.original_text,
                    manual_time: manualDuration,
                    adjustment_count: adjustmentCount,
                    perturb_timings: perturbData.timings,
                    analysis_timings: currentTimings,
                    epsilon_S: perturbData.epsilon_S,
                    changes: perturbData.changes,
                    marked_original_text: perturbData.marked_original_text,
                    marked_perturbed_text: perturbData.marked_perturbed_text
                })
            });
            
            if (!chatRes.ok) {
                throw new Error(`LLM Chat failed: ${chatRes.status}`);
            }

            const chatData = await chatRes.json();
            
            // 3. Show final result
            
            // Helper to parse marked text (@@@LEVEL|text@@@)
            const parseMarkedText = (text) => {
                return text.replace(/@@@(\d+)\|(.*?)@@@/g, (match, level, content) => {
                    return `<span class="sanitized-highlight risk-bg-${level}">${content}</span>`;
                });
            };

            let originalDisplay = parseMarkedText(perturbData.marked_original_text);
            let sanitizedDisplay = parseMarkedText(perturbData.marked_perturbed_text);
            
            // Process LLM response for restoration
            // We create two versions of the HTML: one perturbed (default), one restored.
            let rawResponse = chatData.response;
            let restoredResponseText = chatData.restored_response; // Use server-side restored text
            
            // Parse Markdown
            // Disable auto-linking to prevent email display issues
            // marked.use({ renderer: { link: (href, title, text) => text } }); // Simple disable? No, that disables all links.
            // Just disable autolink?
            // marked.parse(text, { gfm: true, breaks: true }) usually autolinks.
            // We can try to pre-process emails to avoid linking?
            // Or just let it be text.
            
            let htmlPerturbed = marked.parse(rawResponse);
            let htmlRestored = marked.parse(restoredResponseText);
            
            // Remove mailto links manually if marked still adds them
            htmlPerturbed = htmlPerturbed.replace(/<a href="mailto:[^"]+">(.*?)<\/a>/g, '$1');
            htmlRestored = htmlRestored.replace(/<a href="mailto:[^"]+">(.*?)<\/a>/g, '$1');
            
            // Highlight perturbed parts in the default view
            // We do this on the HTML output to avoid breaking markdown syntax
            if (perturbData.changes && perturbData.changes.length > 0) {
                const sortedChanges = [...perturbData.changes].sort((a, b) => b.perturbed.length - a.perturbed.length);
                sortedChanges.forEach(change => {
                    // Use the flexible regex pattern from backend if available
                    let regex;
                    if (change.regex_pattern) {
                        try {
                            // Python regex might contain flags or syntax slightly different, but usually compatible for simple cases
                            // We need to handle the case where regex_pattern is a string
                            regex = new RegExp(change.regex_pattern, 'gi');
                        } catch(e) {
                            console.warn('Invalid regex from backend:', change.regex_pattern);
                            // Fallback to simple escape
                            const escaped = change.perturbed.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                            regex = new RegExp(escaped, 'gi');
                        }
                    } else {
                        // Fallback logic
                        const escaped = change.perturbed.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        if (/^[a-zA-Z]+$/.test(change.perturbed) && change.perturbed.length < 4) {
                             regex = new RegExp(`(?<![a-zA-Z])${escaped}(?![a-zA-Z])`, 'g');
                        } else {
                             regex = new RegExp(escaped, 'g');
                        }
                    }

                    // Use a special class to indicate it's a perturbed entity
                    // We need to be careful not to replace inside HTML tags
                    // This is tricky with regex on HTML.
                    // But for simple demo, we assume text content mostly.
                    try {
                        htmlPerturbed = htmlPerturbed.replace(regex, (match) => `<span class="restorable" title="Perturbed entity">${match}</span>`);
                    } catch(e) {
                        console.error('Highlight replacement failed', e);
                    }
                });
            }

            const msgId = 'llm-res-' + Date.now();
            
            const finalHtml = `
                <div class="d-flex justify-content-end mb-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleAllRestoration('${msgId}')" id="btn-${msgId}">
                        <i class="bi bi-eye"></i> Restore All / ä¸€é”®è¿˜åŸ
                    </button>
                </div>
                <div id="${msgId}" data-perturbed="${encodeURIComponent(htmlPerturbed)}" data-restored="${encodeURIComponent(htmlRestored)}" class="llm-response-content">
                    ${htmlPerturbed}
                </div>
                <div class="privacy-panel mt-3">
                    <details open>
                        <summary class="fw-bold text-primary" style="cursor: pointer; font-size: 0.9rem;">
                            <i class="bi bi-bar-chart-line me-1"></i> Statistics & Privacy Details / ç»Ÿè®¡ä¸éšç§è¯¦æƒ…
                        </summary>
                        <div class="small text-muted mt-2 ps-3 border-start">
                            <div class="mb-2">
                                <strong>Original / åŸå§‹æ–‡æœ¬:</strong><br>
                                <span class="text-break">${originalDisplay}</span>
                            </div>
                            <div class="mb-2">
                                <strong>Sanitized / è„±æ•æ–‡æœ¬:</strong><br>
                                <span class="text-break">${sanitizedDisplay}</span>
                            </div>
                            <div class="border-top pt-2 mt-2">
                                <div class="row g-2">
                                    <div class="col-6">PII Detection / PIIæ£€æµ‹: <strong>${(currentTimings.pii_detection).toFixed(4)}s</strong></div>
                                    <div class="col-6">Risk Mapping / é£é™©æ˜ å°„: <strong>${(currentTimings.risk_assessment).toFixed(4)}s</strong></div>
                                    <div class="col-6">Manual Time / è°ƒæ•´è€—æ—¶: <strong>${perturbData.timings.manual_adjustment.toFixed(4)}s</strong></div>
                                    <div class="col-6">Adjustments / è°ƒæ•´æ¬¡æ•°: <strong>${adjustmentCount} tokens</strong></div>
                                    <div class="col-6">Perturbation / æ‰°åŠ¨è€—æ—¶: <strong>${(perturbData.timings.total_perturbation).toFixed(4)}s</strong></div>
                                    <div class="col-6">LLM Latency / æ¨¡å‹å»¶è¿Ÿ: <strong>${(chatData.timings.llm_latency).toFixed(4)}s</strong></div>
                                    <div class="col-6">Restoration / è¿˜åŸè€—æ—¶: <strong>${(chatData.timings.restoration_time).toFixed(4)}s</strong></div>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
                
                <!-- Survey Section -->
                <div class="survey-container mt-3 p-3 border rounded bg-light" id="survey-${msgId}">
                    <h6 class="fw-bold mb-3"><i class="bi bi-clipboard-check me-2"></i>Feedback Survey / åé¦ˆé—®å·</h6>
                    <form onsubmit="submitSurvey(event, '${msgId}')">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">1. Did this response help you complete your task? / è¿™æ¬¡å“åº”æ˜¯å¦å¸®åŠ©æ‚¨å®Œæˆäº†ä»»åŠ¡ï¼Ÿ</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="q1" id="q1-1-${msgId}" value="1" required>
                                <label class="btn btn-outline-secondary btn-sm" for="q1-1-${msgId}">Unacceptable / æ— æ³•æ¥å—</label>
                                <input type="radio" class="btn-check" name="q1" id="q1-2-${msgId}" value="2">
                                <label class="btn btn-outline-secondary btn-sm" for="q1-2-${msgId}">Poor / è¾ƒå·®</label>
                                <input type="radio" class="btn-check" name="q1" id="q1-3-${msgId}" value="3">
                                <label class="btn btn-outline-secondary btn-sm" for="q1-3-${msgId}">Neutral / ä¸€èˆ¬</label>
                                <input type="radio" class="btn-check" name="q1" id="q1-4-${msgId}" value="4">
                                <label class="btn btn-outline-secondary btn-sm" for="q1-4-${msgId}">Good / è‰¯å¥½</label>
                                <input type="radio" class="btn-check" name="q1" id="q1-5-${msgId}" value="5">
                                <label class="btn btn-outline-secondary btn-sm" for="q1-5-${msgId}">Excellent / ä¼˜ç§€</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">2. Did the sanitized text protect your privacy concerns? / è„±æ•æ–‡æœ¬æ˜¯å¦ä¿æŠ¤äº†æ‚¨å…³åˆ‡çš„éšç§ï¼Ÿ</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="q2" id="q2-1-${msgId}" value="1" required>
                                <label class="btn btn-outline-secondary btn-sm" for="q2-1-${msgId}">Unacceptable / æ— æ³•æ¥å—</label>
                                <input type="radio" class="btn-check" name="q2" id="q2-2-${msgId}" value="2">
                                <label class="btn btn-outline-secondary btn-sm" for="q2-2-${msgId}">Poor / è¾ƒå·®</label>
                                <input type="radio" class="btn-check" name="q2" id="q2-3-${msgId}" value="3">
                                <label class="btn btn-outline-secondary btn-sm" for="q2-3-${msgId}">Neutral / ä¸€èˆ¬</label>
                                <input type="radio" class="btn-check" name="q2" id="q2-4-${msgId}" value="4">
                                <label class="btn btn-outline-secondary btn-sm" for="q2-4-${msgId}">Good / è‰¯å¥½</label>
                                <input type="radio" class="btn-check" name="q2" id="q2-5-${msgId}" value="5">
                                <label class="btn btn-outline-secondary btn-sm" for="q2-5-${msgId}">Excellent / ä¼˜ç§€</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">3. Was the interactive privacy labeling process tiring? / äº¤äº’å¼éšç§æ ‡æ³¨è¿‡ç¨‹æ˜¯å¦ä»¤æ‚¨æ„Ÿåˆ°ç–²æƒ«ï¼Ÿ</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="q3" id="q3-1-${msgId}" value="1" required>
                                <label class="btn btn-outline-secondary btn-sm" for="q3-1-${msgId}">Very Tiring / éå¸¸ç–²æƒ«</label>
                                <input type="radio" class="btn-check" name="q3" id="q3-2-${msgId}" value="2">
                                <label class="btn btn-outline-secondary btn-sm" for="q3-2-${msgId}">Tiring / æ¯”è¾ƒç–²æƒ«</label>
                                <input type="radio" class="btn-check" name="q3" id="q3-3-${msgId}" value="3">
                                <label class="btn btn-outline-secondary btn-sm" for="q3-3-${msgId}">Neutral / ä¸€èˆ¬</label>
                                <input type="radio" class="btn-check" name="q3" id="q3-4-${msgId}" value="4">
                                <label class="btn btn-outline-secondary btn-sm" for="q3-4-${msgId}">Easy / æ¯”è¾ƒè½»æ¾</label>
                                <input type="radio" class="btn-check" name="q3" id="q3-5-${msgId}" value="5">
                                <label class="btn btn-outline-secondary btn-sm" for="q3-5-${msgId}">Very Easy / éå¸¸è½»æ¾</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">4. Is the time spent on privacy adjustment worth it? / èŠ±è´¹æ—¶é—´è°ƒæ•´éšç§æ˜¯å¦å€¼å¾—ï¼Ÿ</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="q4" id="q4-1-${msgId}" value="1" required>
                                <label class="btn btn-outline-secondary btn-sm" for="q4-1-${msgId}">Completely Unworthy / å®Œå…¨ä¸å€¼</label>
                                <input type="radio" class="btn-check" name="q4" id="q4-2-${msgId}" value="2">
                                <label class="btn btn-outline-secondary btn-sm" for="q4-2-${msgId}">Slightly Unworthy / ä¸å¤ªå€¼å¾—</label>
                                <input type="radio" class="btn-check" name="q4" id="q4-3-${msgId}" value="3">
                                <label class="btn btn-outline-secondary btn-sm" for="q4-3-${msgId}">Neutral / ä¸€èˆ¬</label>
                                <input type="radio" class="btn-check" name="q4" id="q4-4-${msgId}" value="4">
                                <label class="btn btn-outline-secondary btn-sm" for="q4-4-${msgId}">Worth It / å€¼å¾—</label>
                                <input type="radio" class="btn-check" name="q4" id="q4-5-${msgId}" value="5">
                                <label class="btn btn-outline-secondary btn-sm" for="q4-5-${msgId}">Very Worth / éå¸¸å€¼å¾—</label>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary btn-sm">Submit Survey / æäº¤é—®å·</button>
                        </div>
                    </form>
                </div>
            `;
            
            updateMessage(botMsgId, finalHtml);
            
            // Disable input until survey is submitted
            document.getElementById('userInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('userInput').placeholder = "Please complete the survey above to continue... / è¯·å…ˆå®Œæˆä¸Šæ–¹é—®å·ä»¥ç»§ç»­...";
            
            // Save Bot Message to Session
            appendMessageToCurrentSession('bot', finalHtml);
            
        } catch (e) {
            console.error(e);
            updateMessage(botMsgId, 'Error processing request.');
        }
    }

    async function submitSurvey(event, msgId) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const surveyData = {
            q1: formData.get('q1'),
            q2: formData.get('q2'),
            q3: formData.get('q3'),
            q4: formData.get('q4'),
            timestamp: Date.now()
        };
        
        // Calculate time taken to fill survey (approximate)
        // We can't easily track open time here without more state, 
        // but we can log the submission timestamp relative to message generation if needed.
        
        try {
            const res = await fetch('/submit_survey', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: userId,
                    survey_data: surveyData
                })
            });
            
            if (res.ok) {
                // Hide survey form and show thank you
                const container = document.getElementById('survey-' + msgId);
                container.innerHTML = '<div class="text-center text-success py-3"><i class="bi bi-check-circle-fill fs-4"></i><br>Thank you for your feedback! / æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼</div>';
                
                // Re-enable input
                document.getElementById('userInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('userInput').placeholder = "Type a message...";
                document.getElementById('userInput').focus();

                // Advance User Study
                if (isUserStudyMode) {
                    userStudyIndex++;
                    setTimeout(() => {
                        loadUserStudyCase();
                    }, 1000);
                }
            } else {
                alert('Failed to submit survey. Please try again.');
            }
        } catch(e) {
            console.error(e);
            alert('Error submitting survey.');
        }
    }
    
    function toggleAllRestoration(msgId) {
        const container = document.getElementById(msgId);
        const btn = document.getElementById('btn-' + msgId);
        if (!container || !btn) return;
        
        const isRestored = container.classList.contains('restored-view');
        
        if (isRestored) {
            // Switch back to perturbed
            container.innerHTML = decodeURIComponent(container.dataset.perturbed);
            container.classList.remove('restored-view');
            btn.innerHTML = '<i class="bi bi-eye"></i> Restore All / ä¸€é”®è¿˜åŸ';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        } else {
            // Switch to restored
            container.innerHTML = decodeURIComponent(container.dataset.restored);
            container.classList.add('restored-view');
            btn.innerHTML = '<i class="bi bi-eye-slash"></i> Show Original / æ˜¾ç¤ºåŸæ–‡';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-success');
        }
    }
    
    // Deprecated single toggle
    function toggleRestore(element, original, perturbed) {
        // ... kept for compatibility if needed, but we moved to Restore All
    }

    function addMessage(html, type, isLoading=false) {
        const container = document.getElementById('chatContainer');
        const welcome = document.getElementById('welcomeScreen');
        if (welcome) welcome.remove();

        msgCounter++;
        const id = 'msg-' + Date.now() + '-' + msgCounter;
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.id = id;
        
        const avatarIcon = type === 'user' ? '<i class="bi bi-person-fill"></i>' : '<i class="bi bi-stars" id="icon-bot"></i>';
        
        // Parse Markdown for bot messages if not loading
        let content = html;
        if (type === 'bot' && !isLoading) {
            // Check if it's the complex HTML structure we build in confirmPrivacy
            // If it starts with <div, it's likely our custom HTML, so we only markdown the text part?
            // Actually, confirmPrivacy sends a mix of text and HTML.
            // The LLM response is at the top.
            // Let's handle this in confirmPrivacy instead for the final message.
            // But for simple messages or history loading, we might need it.
            // For now, let's assume html passed here is raw text for bot unless it contains HTML tags
            if (!html.trim().startsWith('<')) {
                 content = marked.parse(html);
            }
        }

        div.innerHTML = `
            <div class="avatar">${avatarIcon}</div>
            <div class="bubble">
                ${isLoading ? '<span class="loading-spinner"></span> ' : ''}${content}
            </div>
        `;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        return id;
    }

    function updateMessage(id, html) {
        const msg = document.getElementById(id);
        if (msg) {
            // Only update the bubble content, keep avatar
            const bubble = msg.querySelector('.bubble');
            bubble.innerHTML = html;
        }
    }
</script>
</body>
</html>
